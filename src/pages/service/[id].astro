---
import { getCollection, render } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import BookButton from "../../components/BookButton.astro";
import { Icon } from "astro-icon/components";

export async function getStaticPaths() {
  const services = await getCollection("services");
  return services.map((service) => ({
    params: { id: service.slug },
    props: { service },
  }));
}

const { service } = Astro.props;
const { Content } = await render(service);
const { data, slug } = service;

// Fallback for services not yet updated to new schema
const title = data.title;
const img = data.img;

const hero = data.hero || {
  subtitle: data.specification || "",
  phrase: data.description || "",
  cta: "Agendar llamada",
};

const problem = data.problem;
const solution = data.solution;
const automation = data.automation;
const benefits = data.benefits;
const use_cases = data.use_cases;
const methodology = data.methodology;
const final_cta = data.final_cta;

const isLegacy = !problem; // If no problem section, render legacy content mode
---

<Layout title={title}>
  {/* HERO SECTION */}
  <section
    class="relative min-h-[90vh] flex items-center justify-center pt-24 pb-12 overflow-hidden bg-(--color-bg)"
  >
    <div class="container mx-auto px-6 max-w-7xl relative z-10">
      <div class="grid md:grid-cols-2 gap-12 items-center">
        <div class="text-left space-y-8 animate-fade-in-up">
          <h1
            class="text-6xl md:text-8xl font-display font-medium text-(--color-text) tracking-tight leading-[1.1]"
          >
            {title}
          </h1>
          <p class="text-xl md:text-2xl text-(--color-primary) font-medium">
            {hero.subtitle}
          </p>
          <p class="text-xl text-(--color-text-dark) max-w-lg leading-relaxed">
            {hero.phrase}
          </p>
          <div class="pt-6">
            <a
              href="#book"
              class="inline-flex items-center justify-center px-8 py-4 text-base font-medium rounded-full text-(--color-bg) bg-(--color-primary) hover:bg-(--color-primary-hover) transition-all duration-300 shadow-[0_0_20px_rgba(235,170,0,0.3)] hover:shadow-[0_0_30px_rgba(235,170,0,0.5)] transform hover:-translate-y-1"
            >
              {hero.cta}
            </a>
          </div>
        </div>
        <div
          class="relative h-full flex items-center justify-center animate-fade-in"
        >
          <div class="relative w-full aspect-square max-w-[500px]">
            <div
              class="absolute inset-0 bg-linear-to-tr from-(--color-primary)/20 to-transparent rounded-full blur-3xl animate-pulse-slow"
            >
            </div>
            <img
              transition:name={`img-${slug}`}
              src={img}
              alt={title}
              class="relative z-10 w-full h-full object-contain drop-shadow-2xl hover:scale-105 transition-transform duration-700"
            />
          </div>
        </div>
      </div>
    </div>
  </section>

  {
    isLegacy ? (
      <div class="container mx-auto px-4 py-16 max-w-6xl prose prose-lg prose-invert">
        <Content />
      </div>
    ) : (
      <>
        {/* PROBLEM SECTION */}
        {problem && (
          <section class="pt-32 pb-48 bg-(--color-bg-alt) relative">
            <div class="container mx-auto px-6 max-w-7xl">
              <div class="grid md:grid-cols-2 gap-16 items-center">
                <div>
                  <h2 class="text-4xl md:text-5xl font-display text-(--color-text) mb-8 leading-tight">
                    {problem.statement}
                  </h2>
                </div>
                <div class="space-y-6">
                  {problem.points?.map((point) => (
                    <div class="flex items-start gap-4 p-4 rounded-xl hover:bg-(--color-bg)/50 transition-colors">
                      <span class="bg-red-500/10 text-red-400 p-2 rounded-lg mt-1">
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="24"
                          height="24"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <path d="M18 6 6 18" />
                          <path d="m6 6 12 12" />
                        </svg>
                      </span>
                      <p class="text-xl text-(--color-text) font-light">
                        {point}
                      </p>
                    </div>
                  ))}
                </div>
              </div>
            </div>
            <svg
              class="absolute bottom-0 left-0 w-full h-16 md:h-24 text-(--color-bg) z-10 pointer-events-none"
              viewBox="0 0 1200 120"
              preserveAspectRatio="none"
              fill="currentColor"
            >
              <path d="M0,0 L540,0 L600,80 L660,0 L1200,0 L1200,120 L0,120 Z" />
            </svg>
          </section>
        )}

        {/* SOLUTION SECTION */}
        {solution && (
          <section class="py-12 bg-(--color-bg) relative overflow-hidden">
            <div class="absolute inset-0 bg-radial-gradient from-(--color-card) to-transparent opacity-30" />
            <div class="container mx-auto px-6 max-w-4xl text-center relative z-10">
              <h2 class="text-5xl md:text-6xl font-display text-(--color-text) mb-12">
                {solution.title}
              </h2>
              <div class="text-2xl text-(--color-text-dark) leading-relaxed whitespace-pre-line font-light">
                {solution.description}
              </div>
            </div>
          </section>
        )}

        {/* DUAL SECTION: AUTOMATION (INCLUDES) & BENEFITS */}
        {(automation || benefits || use_cases) && (
          <section class="pt-24 bg-(--color-bg-alt) w-full">
            <div class="container mx-auto px-6 max-w-7xl">
              <div class="grid md:grid-cols-2 gap-8">
                {/* LEFT CARD: WHAT INCLUDES (AUTOMATION) */}
                {automation && (
                  <div class="bg-(--color-card) rounded-2xl p-10 border border-white/5 shadow-lg flex flex-col h-full">
                    <h2 class="text-2xl font-display text-(--color-text) mb-8 font-semibold">
                      {automation.title}
                    </h2>
                    <ul class="space-y-4">
                      {automation.items?.map((item) => (
                        <div class="flex items-start gap-4">
                          <span class="text-(--color-primary) mt-1">
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              width="18"
                              height="18"
                              viewBox="0 0 24 24"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                              stroke-linecap="round"
                              stroke-linejoin="round"
                            >
                              <polyline points="20 6 9 17 4 12" />
                            </svg>
                          </span>
                          <p class="text-lg text-(--color-text-dark) leading-snug">
                            {item}
                          </p>
                        </div>
                      ))}
                    </ul>
                  </div>
                )}

                {/* RIGHT CARD: BENEFITS */}
                {benefits && (
                  <div class="bg-(--color-primary)/5 rounded-2xl p-10 border border-(--color-primary)/20 shadow-lg flex flex-col h-full relative overflow-hidden">
                    {/* Subtle gold glow */}
                    <div class="absolute top-0 right-0 w-64 h-64 bg-(--color-primary)/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none" />

                    <h2 class="text-2xl font-display text-(--color-text) mb-8 font-semibold relative z-10">
                      {benefits.title}
                    </h2>
                    <ul class="space-y-4 relative z-10">
                      {benefits.items?.map((item) => (
                        <div class="flex items-start gap-4">
                          <span class="text-(--color-primary) mt-1">
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              width="18"
                              height="18"
                              viewBox="0 0 24 24"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                              stroke-linecap="round"
                              stroke-linejoin="round"
                            >
                              <polyline points="20 6 9 17 4 12" />
                            </svg>
                          </span>
                          <p class="text-lg text-(--color-text) leading-snug">
                            {item}
                          </p>
                        </div>
                      ))}
                    </ul>
                  </div>
                )}
              </div>

              {/* USE CASES SECTION */}
              {use_cases && (
                <div class="mt-16 max-w-5xl mx-auto">
                  <div class="bg-(--color-card) rounded-4xl p-10 md:p-14 border border-white/5 shadow-xl relative overflow-hidden">
                    {/* Subtle background flair */}
                    <div class="absolute bottom-0 left-0 w-64 h-64 bg-(--color-primary)/5 rounded-full blur-3xl translate-y-1/3 -translate-x-1/3" />

                    <h2 class="text-3xl font-display text-(--color-text) mb-10 text-center">
                      {use_cases.title}
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6 relative z-10">
                      {use_cases.items?.map((item) => (
                        <div class="flex items-start gap-4">
                          <span class="text-(--color-primary) mt-1">
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              width="20"
                              height="20"
                              viewBox="0 0 24 24"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                              stroke-linecap="round"
                              stroke-linejoin="round"
                            >
                              <polyline points="9 11 12 14 22 4" />
                              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
                            </svg>
                          </span>
                          <p class="text-xl text-(--color-text-dark) leading-snug">
                            {item}
                          </p>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}
            </div>
            <svg
              data-name="Layer 1"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 1200 120"
              preserveAspectRatio="none"
              class="w-full h-auto block relative mt-24 z-10 -mb-10"
            >
              <path
                d="M985.66,92.83C906.67,72,823.78,31,743.84,14.19c-82.26-17.34-168.06-16.33-250.45.39-57.84,11.73-114,31.07-172,41.86A600.21,600.21,0,0,1,0,27.35V120H1200V95.8C1132.19,118.92,1055.71,111.31,985.66,92.83Z"
                class="shape-fill"
                fill="var(--color-bg)"
                fill-opacity="1"
              />
            </svg>
          </section>
        )}

        {/* FINAL CTA SECTION */}
        {final_cta && (
          <section class="mt-16 py-32 bg-(--color-bg) ">
            <div class="container mx-auto px-6 max-w-4xl text-center relative">
              <h2 class="text-5xl md:text-6xl font-display text-(--color-text) mb-8 leading-tight">
                {final_cta.text}
              </h2>
              <BookButton text={final_cta.button_text} />
            </div>
          </section>
        )}
      </>
    )
  }
</Layout>

<style>
  .animate-pulse-slow {
    animation: pulse 8s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  @keyframes pulse {
    0%,
    100% {
      opacity: 0.2;
    }
    50% {
      opacity: 0.5;
    }
  }
</style>
