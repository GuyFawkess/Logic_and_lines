---
import { useTranslations } from "../i18n/utils";
import LanguageSwitcher from "./LanguageSwitcher.astro";

const { currentLang } = Astro.props;
const t = useTranslations(currentLang);

// Create base URL for the current language
const baseUrl = currentLang === "en" ? "/en/" : "/";
---

<header
  class="w-full h-auto min-h-20 top-0 left-0 right-0 z-50 bg-(--color-bg) sticky flex items-center justify-center"
>
  <!-- Desktop Navigation -->
  <nav class="mx-auto w-full hidden md:block bg-(--color-bg)">
    <div class="container mx-auto px-4 flex items-center justify-between py-2">
      <div class="flex items-center space-x-">
        <!-- Logo on the left -->
        <a
          href={baseUrl}
          class="flex items-center hover:scale-105 transition ease-in-out duration-150 ml-10"
        >
          <img
            data-astro-prefetch
            src="/logoNoSub.svg"
            alt="Logic and Line Logo"
            class="h-auto w-52"
          />
        </a>
        <!-- Nav buttons follow the logo -->
        <ul class="flex items-center space-x-8 py-0 mx-10">
          <li
            class="text-(--color-text) hover:text-(--color-primary) border-none text-lg font-medium"
          >
            <a
              class="inline-block whitespace-nowrap text-center"
              data-value={t.nav.benefits}
              href={`${baseUrl}#benefits`}>{t.nav.benefits}</a
            >
          </li>
          <li
            class="text-(--color-text) hover:text-(--color-primary) border-none text-lg font-medium"
          >
            <a
              class="inline-block whitespace-nowrap text-center"
              data-value={t.nav.services}
              href={`${baseUrl}#services`}>{t.nav.services}</a
            >
          </li>
          <li
            class="text-(--color-text) hover:text-(--color-primary) border-none text-lg font-medium"
          >
            <a
              class="inline-block whitespace-nowrap text-center"
              data-value={t.nav.process}
              href={`${baseUrl}#process`}>{t.nav.process}</a
            >
          </li>
          <li
            class="text-(--color-text) hover:text-(--color-primary) border-none text-lg font-medium"
          >
            <a
              class="inline-block whitespace-nowrap text-center"
              data-value={t.nav.reason}
              href={`${baseUrl}#reasons`}>{t.nav.reason}</a
            >
          </li>
        </ul>
      </div>
      <!-- Language switcher stays on the right -->
      <div class="flex-shrink-0 flex items-center gap-4">
        <LanguageSwitcher currentLang={currentLang} />
        <a
          href={`${baseUrl}#booking`}
          class="scramble-button btn bg-(--color-primary) text-(--color-bg) hover:text-white hover:bg-(--color-primary)/90 border-none font-semibold px-6 whitespace-nowrap h-auto py-2"
          data-value={t.buttons.book}
          style="box-shadow: 0 0.5px 2px var(--color-primary);"
        >
          {t.buttons.book}
        </a>
      </div>
    </div>
  </nav>

  <!-- Mobile Navigation with Burger Menu -->
  <nav class="w-full mx-auto md:hidden bg-(--color-bg) shadow-md py-4">
    <div class="flex items-center justify-between px-8">
      <!-- Logo on the Left -->
      <a href={baseUrl} class="logo">
        <img
          src="/logoNoSub.svg"
          alt="Thai Massage Lanzarote Logo"
          class="h-auto w-54"
        />
      </a>

      <!-- Burger Menu Dropdown on the Right -->
      <div class="dropdown dropdown-end">
        <div
          id="burger-button"
          tabindex="0"
          role="button"
          class="btn btn-ghost btn-circle h-12 w-12 flex justify-center items-center"
        >
          <div id="burger-icon"></div>
        </div>
        <ul
          tabindex="0"
          class="dropdown-content menu bg-(--color-bg-alt) text-(--color-text) rounded-box z-[100] w-52 p-2 shadow-md mt-4"
        >
          <li>
            <a
              href={`${baseUrl}#booking`}
              class="scramble-button btn bg-(--color-primary) text-(--color-bg) hover:text-(--color-bg) hover:bg-(--color-primary)/90 border-none font-semibold w-full mb-2 whitespace-nowrap"
              data-value={t.buttons.book}
              style="box-shadow: 0 0.5px 2px var(--color-primary);"
            >
              {t.buttons.book}
            </a>
          </li>
          <li>
            <a
              href={`${baseUrl}#benefits`}
              class="py-3 text-center justify-center">{t.nav.benefits}</a
            >
          </li>
          <li>
            <a
              transition:name="services"
              href={`${baseUrl}#services`}
              class="py-3 text-center justify-center">{t.nav.services}</a
            >
          </li>
          <li>
            <a
              href={`${baseUrl}#process`}
              class="py-3 text-center justify-center">{t.nav.process}</a
            >
          </li>
          <li>
            <a
              href={`${baseUrl}#reasons`}
              class="py-3 text-center justify-center">{t.nav.reason}</a
            >
          </li>
          <li></li>
          <div class="navbar-end mt-2 flex justify-center w-full my-2">
            <LanguageSwitcher currentLang={currentLang} />
          </div>
        </ul>
      </div>
    </div>
  </nav>
</header>

<style>
  /* Existing styles */
  .menu li a {
    color: var(--color-text);
    font-weight: 500;
    transition: color 0.3s ease;
    display: flex;
    justify-content: center;
    text-align: center;
  }

  .menu li a:hover {
    color: var(--color-primary);
  }

  /* Burger Menu Animation */
  #burger-button {
    background-color: transparent;
    border: none;
    cursor: pointer;
    /* Dimensions handled by btn-circle but ensures centering */
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Trigger animation when dropdown is active (focus logic)
     This ensures the icon always matches the menu state */
  .dropdown:focus-within #burger-button #burger-icon {
    background-color: transparent;
  }

  .dropdown:focus-within #burger-button #burger-icon:before {
    top: 0px;
    transform: rotate(-45deg);
  }

  .dropdown:focus-within #burger-button #burger-icon:after {
    bottom: 0px;
    transform: rotate(45deg);
  }

  #burger-icon {
    background-color: var(--color-text);
    border-radius: 50px;
    height: 3px;
    width: 30px;
    position: relative;
    transition: all 0.25s;
  }

  #burger-icon:before,
  #burger-icon:after {
    background-color: var(--color-text);
    border-radius: 50px;
    content: "";
    height: 3px;
    left: 0px;
    position: absolute;
    transition: all 0.25s;
    width: 30px;
  }

  #burger-icon:before {
    top: -10px;
  }

  #burger-icon:after {
    bottom: -10px;
  }
</style>

<script>
  // Simple script to handle "click again to close" behavior for focus-based dropdowns
  function setupBurgerMenu() {
    const button = document.getElementById("burger-button");
    if (!button) return;

    // Prevent attaching multiple listeners
    if (button.dataset.bound === "true") return;
    button.dataset.bound = "true";

    button.addEventListener("mousedown", (e) => {
      // If the button already has focus, this click should close it (blur)
      if (document.activeElement === button) {
        button.blur();
        e.preventDefault(); // Prevent immediate refocus
      }
    });
  }

  // Run on initial load
  setupBurgerMenu();

  // Re-run after page transitions
  document.addEventListener("astro:page-load", setupBurgerMenu);
</script>
<script>
  const letters = "abcdefghijklmnopqrstuvwxyz";

  // Bind the effect to all buttons, avoid double-binding, and keep per-button intervals
  function setupScrambleEffect() {
    const buttons = document.querySelectorAll(
      ".scramble-button",
    ) as NodeListOf<HTMLElement>;
    if (!buttons.length) return;

    buttons.forEach((button) => {
      // Prevent attaching duplicate listeners across page transitions
      if (button.dataset.bound === "true") return;
      button.dataset.bound = "true";

      let interval: NodeJS.Timeout | null = null;

      button.addEventListener("mouseover", (event) => {
        let iteration = 0;
        const target = event.currentTarget as HTMLElement;

        // Lock width to prevent horizontal jitter
        const fixedWidth = target.getBoundingClientRect().width;
        target.style.width = fixedWidth + "px";

        // target.style.fontFamily = "monospace"; // Keep disabled to prevent vertical jump

        if (interval) clearInterval(interval);

        interval = setInterval(() => {
          const value = target.dataset.value || target.textContent || "";
          target.innerText = target.innerText
            .split("")
            .map((letter, index) => {
              if (index < iteration) {
                return value[index] || "";
              }
              return letters[Math.floor(Math.random() * letters.length)];
            })
            .join("");

          if (iteration >= value.length) {
            if (interval) clearInterval(interval);
            target.innerText = value;
            target.style.width = ""; // Release width lock
            // target.style.fontFamily = "";
          }

          iteration += 1 / 3;
        }, 30);
      });
    });
  }

  // Run on initial load
  setupScrambleEffect();

  // Re-run after page transitions (if using Astro's view transitions)
  document.addEventListener("astro:page-load", setupScrambleEffect);
</script>
